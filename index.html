<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Creator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    .book-entry { margin: 10px 0; padding: 10px; border: 1px solid #ccc; cursor: pointer; }
    #book-reader.fullscreen {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: white; padding: 40px; overflow: auto; z-index: 999;
    }
  </style>
</head>
<body>

  <h1>Create a Book</h1>
  <input type="text" id="title" placeholder="Title"><br>
  <input type="text" id="author" placeholder="Author"><br>
  <textarea id="content" placeholder="Book Content..." rows="5" cols="50"></textarea><br>
  <select id="visibility">
    <option value="public">Public</option>
    <option value="protected">Protected</option>
  </select><br>
  <input type="text" id="key" placeholder="API Key (if protected)" disabled><br>
  <button onclick="publishBook()">Publish Book</button>

  <hr>
  <h2>Your Dashboard</h2>
  <div id="dashboard"></div>

  <div id="book-reader" class="hidden fullscreen"></div>

  <script>
    const keyInput = document.getElementById("key");
    document.getElementById("visibility").addEventListener("change", e => {
      keyInput.disabled = e.target.value !== "protected";
    });

    let bookData = { books: [], context: {} };

    async function loadBooks() {
      try {
        const res = await fetch("books.json");
        bookData = await res.json();
        renderDashboard();
      } catch (err) {
        console.error("Failed to load books.json:", err);
      }
    }

    function renderDashboard() {
      const dashboard = document.getElementById("dashboard");
      dashboard.innerHTML = "";

      bookData.books.forEach(book => {
        const entry = document.createElement("div");
        entry.className = "book-entry";
        entry.textContent = `${book.title} by ${book.author}`;
        entry.onclick = () => readBook(book);
        dashboard.appendChild(entry);
      });
    }

    function readBook(book) {
      if (book.visibility === "protected") {
        const input = prompt("Enter API Key:");
        if (input !== book.apiKey) return alert("Wrong API key.");
      }

      const reader = document.getElementById("book-reader");
      reader.innerHTML = `<h1>${book.title}</h1><h3>${book.author}</h3><p>${book.content}</p>`;
      reader.classList.remove("hidden");
      reader.classList.add("fullscreen");

      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          reader.classList.add("hidden");
          reader.classList.remove("fullscreen");
        }
      });
    }

    async function publishBook() {
      const title = document.getElementById("title").value.trim();
      const author = document.getElementById("author").value.trim();
      const content = document.getElementById("content").value.trim();
      const visibility = document.getElementById("visibility").value;
      const apiKey = visibility === "protected" ? document.getElementById("key").value.trim() : "";

      if (!title || !author || !content) return alert("Fill in all fields!");

      const newBook = {
        id: Date.now(),
        title,
        author,
        content,
        visibility,
        apiKey,
        publishedAt: new Date().toISOString()
      };

      bookData.books.push(newBook);
      bookData.context.lastUpdated = new Date().toISOString();

      try {
        await fetch("books.json", {
          method: "PUT", // json-server or server must support PUT
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bookData, null, 2)
        });
        renderDashboard();
        alert("Book published successfully!");
      } catch (err) {
        console.error("Failed to write to books.json:", err);
        alert("Note: Cannot save to books.json without a backend or json-server.");
        renderDashboard(); // still add to UI
      }
    }

    loadBooks();
  </script>

</body>
</html>
