<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Creator with JSON</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    .book-entry { margin: 10px 0; padding: 10px; border: 1px solid #ccc; cursor: pointer; }
    #book-reader.fullscreen {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: white; padding: 40px; overflow: auto; z-index: 999;
    }
  </style>
</head>
<body>

  <div id="creator">
    <h1>Create Book</h1>
    <input type="text" id="title" placeholder="Title" required><br>
    <input type="text" id="author" placeholder="Author" required><br>
    <textarea id="content" placeholder="Content..." rows="5" required></textarea><br>

    <select id="visibility">
      <option value="public">Public</option>
      <option value="protected">Protected</option>
    </select><br>
    <input type="text" id="key" placeholder="API Key (for protected)" disabled><br>

    <button onclick="publishBook()">Publish</button>
  </div>

  <div id="dashboard" class="hidden">
    <h2>Your Dashboard</h2>
    <div id="book-list"></div>
  </div>

  <div id="book-reader" class="hidden fullscreen"></div>

  <script>
    let books = [];

    const keyInput = document.getElementById("key");
    document.getElementById("visibility").addEventListener("change", e => {
      keyInput.disabled = e.target.value !== "protected";
    });

    async function loadBooks() {
      try {
        const res = await fetch('books.json');
        books = await res.json();
        showDashboard();
      } catch (e) {
        console.error("Failed to load books.json", e);
      }
    }

    async function publishBook() {
      const title = document.getElementById("title").value;
      const author = document.getElementById("author").value;
      const content = document.getElementById("content").value;
      const visibility = document.getElementById("visibility").value;
      const apiKey = visibility === "protected" ? document.getElementById("key").value : null;

      const book = {
        title, author, content, visibility, apiKey
      };

      books.push(book);

      try {
        await fetch('books.json', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(books, null, 2)
        });
        loadBooks();
      } catch (e) {
        console.error("Failed to save to books.json", e);
      }

      document.getElementById("creator").classList.add("hidden");
    }

    function showDashboard() {
      const dash = document.getElementById("dashboard");
      const list = document.getElementById("book-list");
      dash.classList.remove("hidden");
      list.innerHTML = '';

      books.forEach((book, i) => {
        const div = document.createElement("div");
        div.className = "book-entry";
        div.textContent = `${book.title} by ${book.author}`;
        div.onclick = () => openBook(i);
        list.appendChild(div);
      });
    }

    function openBook(index) {
      const book = books[index];
      if (book.visibility === "protected") {
        const entered = prompt("Enter API Key:");
        if (entered !== book.apiKey) return alert("Wrong key!");
      }

      const reader = document.getElementById("book-reader");
      reader.innerHTML = `<h1>${book.title}</h1><h3>${book.author}</h3><p>${book.content}</p>`;
      reader.classList.remove("hidden");
      reader.classList.add("fullscreen");

      document.addEventListener("keydown", e => {
        if (e.key === "Escape") {
          reader.classList.add("hidden");
          reader.classList.remove("fullscreen");
        }
      });
    }

    loadBooks();
  </script>
</body>
</html>
